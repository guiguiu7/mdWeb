# ==核心实体==
enum NodeState: 
    NONE,      // 未开始
    REVIEWING, // 审批中
    OK,        // 通过
    FAILED     // 驳回

enum ReviewType:
    OR,        // 或签
    AND        // 会签

enum UserState:
    NONE,      // 未处理
    REVIEWING, // 审批中
    OK,        // 通过
    FAILED,    // 驳回
    SKIP       // 跳过

class ReviewFlow:
    Long id
    String name
    List<ReviewNode> nodes

class ReviewNode:
    Long id
    Long flowId
    Integer index      // 节点顺序
    NodeState state
    ReviewType type
    List<ReviewNodeUser> users

class ReviewNodeUser:
    Long id
    Long nodeId
    Long userId
    UserState state

# ==服务类==
class ApprovalService:

    # === 入口：创建审批流程 ===
    function startApprovalFlow(Long flowId, Long businessId):
        flow = flowRepo.findById(flowId)
        firstNode = getFirstNode(flow)  # 获取流程的第一个节点
        
        # 初始化节点状态
        firstNode.state = NodeState.REVIEWING
        nodeRepo.save(firstNode)
        
        # 根据节点类型初始化审批人
        if firstNode.type == ReviewType.OR:
            initOrSignNode(firstNode, businessId)
        else: # AND
            initAndSignNode(firstNode, businessId, firstUser=true)
        
        # 发送通知
        notifyNodeStart(firstNode, businessId)
    
    # === 处理用户审批 ===
    function handleUserApproval(Long userId, Long businessId, ApprovalDecision decision):
        # 获取当前审批任务
        currentTask = taskRepo.findActiveTask(userId, businessId)
        currentUser = currentTask.user
        currentNode = currentTask.node
        
        # 更新用户状态
        currentUser.state = (decision == APPROVE) ? UserState.OK : UserState.FAILED
        userRepo.save(currentUser)
        
        # 处理节点状态
        if currentNode.type == ReviewType.OR:
            handleOrSignDecision(currentNode, currentUser, decision)
        else: # AND
            handleAndSignDecision(currentNode, currentUser, decision, businessId)
        
        # 记录审批日志
        logApprovalAction(userId, businessId, decision)
    
    # === 或签节点初始化 ===
    function initOrSignNode(ReviewNode node, Long businessId):
        # 所有审批人同时进入审批状态
        for user in node.users:
            user.state = UserState.REVIEWING
            createApprovalTask(user, businessId)
        userRepo.saveAll(node.users)
    
    # === 会签节点初始化 ===
    function initAndSignNode(ReviewNode node, Long businessId, Boolean firstUser=false):
        if firstUser:
            # 首个用户进入审批状态
            firstUser = getFirstUser(node.users)
            firstUser.state = UserState.REVIEWING
            createApprovalTask(firstUser, businessId)
            userRepo.save(firstUser)
        else:
            # 获取下一个审批人
            nextUser = getNextPendingUser(node.users)
            if nextUser:
                nextUser.state = UserState.REVIEWING
                createApprovalTask(nextUser, businessId)
                userRepo.save(nextUser)
            else:
                # 所有用户已完成审批
                finalizeNode(node, businessId)
    
    # === 处理或签审批结果 ===
    function handleOrSignDecision(ReviewNode node, ReviewNodeUser user, ApprovalDecision decision):
        if decision == APPROVE:
            # 通过：跳过其他用户，节点通过
            for u in node.users:
                if u.id != user.id:
                    u.state = UserState.SKIP
            node.state = NodeState.OK
        else: 
            # 驳回：节点驳回
            node.state = NodeState.FAILED
        
        nodeRepo.save(node)
        moveToNextNode(node.flow, node.index+1)
    
    # === 处理会签审批结果 ===
    function handleAndSignDecision(ReviewNode node, ReviewNodeUser user, ApprovalDecision decision, Long businessId):
        if decision == REJECT:
            # 驳回：节点驳回
            node.state = NodeState.FAILED
            nodeRepo.save(node)
            return
        
        # 检查是否所有用户都已审批
        if allUsersCompleted(node.users):
            node.state = NodeState.OK
            nodeRepo.save(node)
            moveToNextNode(node.flow, node.index+1)
        else:
            # 初始化下一个审批人
            initAndSignNode(node, businessId)
    
    # === 推进到下一节点 ===
    function moveToNextNode(ReviewFlow flow, Integer nextIndex):
        nextNode = flow.getNodeByIndex(nextIndex)
        if not nextNode:
            # 流程结束
            completeFlow(flow)
            return
        
        # 初始化新节点
        nextNode.state = NodeState.REVIEWING
        nodeRepo.save(nextNode)
        
        if nextNode.type == ReviewType.OR:
            initOrSignNode(nextNode, flow.businessId)
        else: # AND
            initAndSignNode(nextNode, flow.businessId, firstUser=true)
        
        notifyNodeStart(nextNode, flow.businessId)
    
    # === 辅助函数 ===
    function getFirstNode(ReviewFlow flow) -> ReviewNode:
        return flow.nodes.sortByIndex().first()
    
    function getFirstUser(List<ReviewNodeUser> users) -> ReviewNodeUser:
        return users.sortByOrder().first()
    
    function getNextPendingUser(List<ReviewNodeUser> users) -> ReviewNodeUser:
        return users.filter(u -> u.state == UserState.NONE)
                   .sortByOrder()
                   .first()
    
    function allUsersCompleted(List<ReviewNodeUser> users) -> Boolean:
        return users.every(u -> u.state in [OK, FAILED, SKIP])






​    

    stateDiagram-v2
        [*] --> FlowStarted： 创建审批
        FlowStarted --> FirstNode： 初始化首节点
        state FirstNode {
            [*] --> NodeInitializing
            NodeInitializing --> OR_Processing： 或签节点
            NodeInitializing --> AND_Processing： 会签节点
    
            state OR_Processing {
                [*] --> NotifyAllUsers
                NotifyAllUsers --> WaitingApproval
                WaitingApproval --> Approved： 任意人通过
                WaitingApproval --> Rejected： 任意人驳回
            }
    
            state AND_Processing {
                [*] --> NotifyFirstUser
                NotifyFirstUser --> WaitingCurrentUser
                WaitingCurrentUser --> ProcessDecision
                ProcessDecision --> NotifyNextUser： 通过且还有未审批
                ProcessDecision --> NodeCompleted： 通过且最后一人/驳回
            }
        }
    
        FirstNode --> NextNode： 节点完成
        NextNode --> FinalNode： 继续处理
        FinalNode --> [*]： 流程结束

### 关键流程说明

1. **或签节点处理**：
   - 同时通知所有审批人
   - 任意一人通过 → 整个节点通过
   - 任意一人驳回 → 整个节点驳回
   - 通过后其他审批人标记为SKIP
2. **会签节点处理**：
   - 严格串行审批：一个接一个
   - 仅当上一个审批人完成，才通知下一个
   - 所有审批人通过 → 节点通过
   - 任意一人驳回 → 节点立即驳回
3. **状态推进**：
   - 节点完成 → 自动推进到下一节点
   - 最后一节点完成 → 整个流程结束
   - 驳回 → 流程终止
4. **异常处理**：
   - 审批超时：通过定时任务检测并发送提醒
   - 审批人缺席：支持转审或跳过机制
   - 并发控制：使用乐观锁防止状态冲突

![deepseek_mermaid_20250801_1f8bde](F:\deepseek_mermaid_20250801_1f8bde.png)