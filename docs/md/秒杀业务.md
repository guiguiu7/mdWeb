##### 库存预热与减库存

```java
// 1. Redis库存服务（预减库存）
public class RedisInventoryService {
    private JedisPool jedisPool;
    
    // 初始化库存
    public void initStock(long itemId, int stock) {
        try (Jedis jedis = jedisPool.getResource()) {
            jedis.set("seckill:stock:" + itemId, String.valueOf(stock));
        }
    }
    
    // 原子扣减库存
    public boolean reduceStock(long itemId) {
        String script = 
            "if tonumber(redis.call('get', KEYS[1])) > 0 then " +
            "   redis.call('decr', KEYS[1]) " +
            "   return 1 " +
            "else " +
            "   return 0 " +
            "end";
        
        try (Jedis jedis = jedisPool.getResource()) {
            Object result = jedis.eval(script, 1, "seckill:stock:" + itemId);
            return ((Long) result) == 1L;
        }
    }
}
```

##### 秒杀模块

```java
// 2. 秒杀服务（请求入口）
public class SeckillController {
    @Autowired
    private RedisInventoryService redisInventoryService;
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @PostMapping("/seckill")
    public SeckillResponse seckill(@RequestBody SeckillRequest request) {
        // 1. 预减Redis库存
        if (!redisInventoryService.reduceStock(request.getItemId())) {
            return SeckillResponse.fail("库存不足");
        }
        
        // 2. 生成订单ID
        String orderId = IdGenerator.nextId();
        
        // 3. 发送订单创建事件
        Map<String, Object> message = new HashMap<>();
        message.put("eventType", "ORDER_CREATED");
        message.put("orderId", orderId);
        message.put("userId", request.getUserId());
        message.put("itemId", request.getItemId());
        
        rabbitTemplate.convertAndSend(
            "SECKILL_EXCHANGE",
            "order.created",
            message,
            m -> {
                m.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);
                return m;
            }
        );
        
        // 4. 立即响应
        return SeckillResponse.success(orderId);
    }
}
```

##### 订单模块

```java
// 3. 订单服务（消费订单创建事件）
@Component
public class OrderCreatedListener {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @RabbitListener(queues = "ORDER_CREATED_QUEUE")
    public void handleOrderCreated(Map<String, Object> message) {
        String orderId = (String) message.get("orderId");
        Long userId = (Long) message.get("userId");
        Long itemId = (Long) message.get("itemId");
        
        // 幂等检查
        if (orderRepository.existsById(orderId)) {
            return;
        }
        
        // 创建订单
        Order order = new Order();
        order.setId(orderId);
        order.setUserId(userId);
        order.setItemId(itemId);
        order.setStatus(OrderStatus.CREATED);
        order.setCreateTime(LocalDateTime.now());
        orderRepository.save(order);
        
        // 发送库存锁定事件
        Map<String, Object> inventoryMsg = new HashMap<>();
        inventoryMsg.put("eventType", "LOCK_INVENTORY");
        inventoryMsg.put("orderId", orderId);
        inventoryMsg.put("itemId", itemId);
        
        rabbitTemplate.convertAndSend(
            "SECKILL_EXCHANGE", 
            "inventory.lock", 
            inventoryMsg
        );
        
        // 发送支付超时检查（延迟消息）
        rabbitTemplate.convertAndSend(
            "DELAY_EXCHANGE",  // 配置延迟交换器
            "order.timeout",
            message,
            m -> {
                m.getMessageProperties().setDelay(15 * 60 * 1000); // 15分钟延迟
                return m;
            }
        );
    }
}
```

##### 库存模块

```java
// 4. 库存服务（数据库库存扣减）
@Component
public class InventoryLockListener {
    @Autowired
    private InventoryRepository inventoryRepository;
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @RabbitListener(queues = "INVENTORY_LOCK_QUEUE")
    public void handleInventoryLock(Map<String, Object> message) {
        String orderId = (String) message.get("orderId");
        Long itemId = (Long) message.get("itemId");
        
        // 幂等检查
        if (inventoryRepository.isLocked(orderId)) {
            return;
        }
        
        // 乐观锁更新库存
        int affectedRows = inventoryRepository.reduceStockWithOptimisticLock(itemId);
        
        if (affectedRows > 0) {
            // 记录锁定日志
            inventoryRepository.logLock(orderId, itemId);
            
            // 发送支付准备事件
            Map<String, Object> paymentMsg = new HashMap<>();
            paymentMsg.put("eventType", "PREPARE_PAYMENT");
            paymentMsg.put("orderId", orderId);
            rabbitTemplate.convertAndSend(
                "SECKILL_EXCHANGE", 
                "payment.prepare", 
                paymentMsg
            );
        } else {
            // 库存不足，触发补偿
            Map<String, Object> compensateMsg = new HashMap<>();
            compensateMsg.put("eventType", "INVENTORY_COMPENSATE");
            compensateMsg.put("orderId", orderId);
            compensateMsg.put("itemId", itemId);
            compensateMsg.put("reason", "库存不足");
            
            rabbitTemplate.convertAndSend(
                "SECKILL_EXCHANGE", 
                "compensate.inventory", 
                compensateMsg
            );
        }
    }
}
```

##### 支付模块

```java
// 5. 支付服务
@Component
public class PaymentListener {
    @Autowired
    private PaymentService paymentService;
    
    @RabbitListener(queues = "PAYMENT_PREPARE_QUEUE")
    public void preparePayment(Map<String, Object> message) {
        String orderId = (String) message.get("orderId");
        
        // 创建支付订单
        String payUrl = paymentService.createPaymentOrder(orderId);
        
        // TODO: 发送支付链接给用户（通过WebSocket/Push）
    }
    
    // 支付回调
    @PostMapping("/payment/callback")
    public void paymentCallback(@RequestBody PaymentCallbackRequest request) {
        if (request.isSuccess()) {
            Map<String, Object> msg = new HashMap<>();
            msg.put("eventType", "PAYMENT_SUCCESS");
            msg.put("orderId", request.getOrderId());
            rabbitTemplate.convertAndSend(
                "SECKILL_EXCHANGE",
                "order.paid",
                msg
            );
        } else {
            // 支付失败处理
        }
    }
}
```

##### 补偿服务

```java
// 6. 补偿服务（最终一致性保障）
@Component
public class CompensateListener {
    @Autowired
    private RedisInventoryService redisInventoryService;
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private InventoryRepository inventoryRepository;
    
    // 库存补偿
    @RabbitListener(queues = "COMPENSATE_INVENTORY_QUEUE")
    public void handleInventoryCompensate(Map<String, Object> message) {
        String orderId = (String) message.get("orderId");
        Long itemId = (Long) message.get("itemId");
        
        // 1. 回滚Redis库存
        redisInventoryService.rollbackStock(itemId);
        
        // 2. 标记订单失效
        orderRepository.updateStatus(orderId, OrderStatus.INVALID);
        
        // 3. 记录补偿日志
        inventoryRepository.logCompensate(orderId, "库存不足回滚");
    }
    
    // 订单超时处理
    @RabbitListener(queues = "ORDER_TIMEOUT_QUEUE")
    public void handleOrderTimeout(Map<String, Object> message) {
        String orderId = (String) message.get("orderId");
        
        Order order = orderRepository.findById(orderId);
        if (order != null && order.getStatus() == OrderStatus.CREATED) {
            // 1. 关闭订单
            orderRepository.updateStatus(orderId, OrderStatus.TIMEOUT_CLOSED);
            
            // 2. 触发库存回滚
            Map<String, Object> compensateMsg = new HashMap<>();
            compensateMsg.put("eventType", "INVENTORY_COMPENSATE");
            compensateMsg.put("orderId", orderId);
            compensateMsg.put("itemId", order.getItemId());
            compensateMsg.put("reason", "订单超时");
            
            rabbitTemplate.convertAndSend(
                "SECKILL_EXCHANGE", 
                "compensate.inventory", 
                compensateMsg
            );
        }
    }
}
```

